version: v1.0
name: 'confluent-kafka-dotnet build pipeline'
agent:
  machine:
    type: s1-prod-ubuntu20-04-amd64-1
global_job_config:
  prologue:
    commands:
      - checkout
  env_vars:
    - name: CONFIGURATION
      value: Release
    - name: DOTNET_CLI_TELEMETRY_OPTOUT
      value: 'true'

blocks:
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
=======
>>>>>>> 7d7d98a (Final build - (1))
  - name: 'Linux x64'
    dependencies: [ ]
    task:
      agent:
        machine:
          type: s1-prod-ubuntu20-04-amd64-2
      jobs:
        - name: 'Build and test'
          commands:
            - dotnet restore
            - make build
            - make test
  - name: 'OSX x64'
    dependencies: [ ]
    task:
      agent:
        machine:
          type: s1-prod-macos
      jobs:
        - name: 'Build and test'
          commands:
            - ulimit -n 1024
            - dotnet restore
            - make build
            - make test
  - name: 'Windows x64'
    dependencies: [ ]
    task:
      agent:
        machine:
          type: s1-prod-windows
      jobs:
        - name: 'Build and test'
          commands:
            - wget https://dot.net/v1/dotnet-install.ps1 -OutFile dotnet-install.ps1
            - powershell -ExecutionPolicy ByPass -File dotnet-install.ps1 -Version 6.0.403 -InstallDir C:\dotnet
            - $Env:Path += ";C:\dotnet"
            - dotnet restore
            - dotnet test -c ${CONFIGURATION} --no-build test/Confluent.Kafka.UnitTests/Confluent.Kafka.UnitTests.csproj
            - dotnet test -c ${CONFIGURATION} --no-build test/Confluent.SchemaRegistry.UnitTests/Confluent.SchemaRegistry.UnitTests.csproj
            - dotnet test -c ${CONFIGURATION} --no-build test/Confluent.SchemaRegistry.Serdes.UnitTests/Confluent.SchemaRegistry.Serdes.UnitTests.csproj
  - name: 'Windows Artifacts on untagged commits'
    run:
      when: "tag !~ '.*'"
    dependencies:
      - 'Windows x64'
    task:
      agent:
        machine:
          type: s1-prod-windows
      jobs:
        - name: 'Build and push artifacts'
          commands:
            - wget https://dot.net/v1/dotnet-install.ps1 -OutFile dotnet-install.ps1
            - powershell -ExecutionPolicy ByPass -File dotnet-install.ps1 -Version 6.0.403 -InstallDir C:\dotnet
            - $Env:Path += ";C:\dotnet"
            - dotnet tool update -g docfx
            - dotnet restore
            - dotnet build Confluent.Kafka.sln -c ${Env:CONFIGURATION}
            - dotnet pack src/Confluent.Kafka/Confluent.Kafka.csproj -c ${Env:CONFIGURATION} --version-suffix ci-${Env:SEMAPHORE_JOB_ID} --output artifacts
            - dotnet pack src/Confluent.SchemaRegistry/Confluent.SchemaRegistry.csproj -c ${Env:CONFIGURATION} --version-suffix ci-${Env:SEMAPHORE_JOB_ID} --output artifacts
            - dotnet pack src/Confluent.SchemaRegistry.Serdes.Avro/Confluent.SchemaRegistry.Serdes.Avro.csproj -c ${Env:CONFIGURATION} --version-suffix ci-${Env:SEMAPHORE_JOB_ID} --output artifacts
            - dotnet pack src/Confluent.SchemaRegistry.Serdes.Protobuf/Confluent.SchemaRegistry.Serdes.Protobuf.csproj -c ${Env:CONFIGURATION} --version-suffix ci-${Env:SEMAPHORE_JOB_ID} --output artifacts
            - dotnet pack src/Confluent.SchemaRegistry.Serdes.Json/Confluent.SchemaRegistry.Serdes.Json.csproj -c ${Env:CONFIGURATION} --version-suffix ci-${Env:SEMAPHORE_JOB_ID} --output artifacts
            - docfx doc/docfx.json
            - tar.exe -cvzf docs-${Env:SEMAPHORE_JOB_ID}.zip doc/_site/*
            - move docs-${Env:SEMAPHORE_JOB_ID}.zip artifacts
            - artifact push workflow artifacts
  - name: 'Windows Artifacts on tagged commits'
    run:
      when: "tag =~ '.*'"
    dependencies:
      - 'Windows x64'
    task:
      agent:
        machine:
          type: s1-prod-windows
      jobs:
        - name: 'Build and push artifacts'
          commands:
            - wget https://dot.net/v1/dotnet-install.ps1 -OutFile dotnet-install.ps1
            - powershell -ExecutionPolicy ByPass -File dotnet-install.ps1 -Version 6.0.403 -InstallDir C:\dotnet
            - $Env:Path += ";C:\dotnet"
            - dotnet tool update -g docfx
            - dotnet restore
            - dotnet build Confluent.Kafka.sln -c ${Env:CONFIGURATION}
            - dotnet pack src/Confluent.Kafka/Confluent.Kafka.csproj -c ${Env:CONFIGURATION} --output artifacts
            - dotnet pack src/Confluent.SchemaRegistry/Confluent.SchemaRegistry.csproj -c ${Env:CONFIGURATION} --output artifacts
            - dotnet pack src/Confluent.SchemaRegistry.Serdes.Avro/Confluent.SchemaRegistry.Serdes.Avro.csproj -c ${Env:CONFIGURATION} --output artifacts
            - dotnet pack src/Confluent.SchemaRegistry.Serdes.Protobuf/Confluent.SchemaRegistry.Serdes.Protobuf.csproj -c ${Env:CONFIGURATION} --output artifacts
            - dotnet pack src/Confluent.SchemaRegistry.Serdes.Json/Confluent.SchemaRegistry.Serdes.Json.csproj -c ${Env:CONFIGURATION} --output artifacts
            - docfx doc/docfx.json
            - tar.exe -cvzf docs-${Env:SEMAPHORE_JOB_ID}.zip doc/_site/*
            - move docs-${Env:SEMAPHORE_JOB_ID}.zip artifacts
            - artifact push workflow artifacts
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
=======
>>>>>>> 0d10166 (Initial build try)
=======
>>>>>>> 70283a3 (ignoring flaky tests)
=======
>>>>>>> 7d7d98a (Final build - (1))
  - name: 'Integration tests'
    dependencies: [ ]
    task:
      agent:
        machine:
          type: s1-prod-ubuntu20-04-amd64-2
      jobs:
        - name: 'Build and test'
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
          commands:
<<<<<<< HEAD
            - cd test/docker && docker-compose up -d && sleep 30 && cd ../..
            - export SEMAPHORE_SKIP_FLAKY_TETSTS='true'
=======
            - cd test/docker && docker-compose up -d && cd ../..
            - export onSemaphore='set'
>>>>>>> 70283a3 (ignoring flaky tests)
            - dotnet restore
            - cd test/Confluent.Kafka.IntegrationTests && dotnet test -l "console;verbosity=normal" && cd ../..
=======
  # - name: 'Integration tests'
  #   dependencies: [ ]
  #   task:
  #     agent:
  #       machine:
  #         type: s1-prod-ubuntu20-04-amd64-2
  #     jobs:
  #       - name: 'Build and test'
  #         commands:
  #           - cd test/docker && docker-compose up -d && cd ../..
  #           - export onSemaphore='set'
  #           - dotnet restore
  #           - cd test/Confluent.Kafka.IntegrationTests && dotnet test -l "console;verbosity=normal" && cd ../..
>>>>>>> 8c53865 (faster response cycle)
=======
          commands:
            - cd test/docker && docker-compose up -d && cd ../..
            - export SEMAPHORE_SKIP_FLAKY_TETSTS='true'
            - dotnet restore
            - cd test/Confluent.Kafka.IntegrationTests && dotnet test -l "console;verbosity=normal" && cd ../..
>>>>>>> 7d7d98a (Final build - (1))
  - name: 'Schema registry and serdes integration tests'
    dependencies: [ ]
    task:
      agent:
        machine:
          type: s1-prod-ubuntu20-04-amd64-2
=======
            commands:
              - cd test/docker && docker-compose up -d && cd ../..
              - dotnet restore
              - cd test/Confluent.Kafka.IntegrationTests && dotnet test -l "console;verbosity=normal" && cd ../..
=======
          commands:
            - cd test/docker && docker-compose up -d && cd ../..
            - dotnet restore
            - cd test/Confluent.Kafka.IntegrationTests && dotnet test -l "console;verbosity=normal" && cd ../..
>>>>>>> dac6f59 (Initial build try-(2))
  - name: 'Schema registry and serdes integration tests'
<<<<<<< HEAD
      dependencies: [ ]
      task:
        agent:
          machine:
            type: s1-prod-ubuntu20-04-amd64-2
>>>>>>> 0d10166 (Initial build try)
=======
    dependencies: [ ]
    task:
      agent:
        machine:
          type: s1-prod-ubuntu20-04-amd64-2
>>>>>>> 6aabbdf (Initial build try-(3))
      jobs:
        - name: 'Build and test'
          commands:
            - cd test/docker && docker-compose up -d && cd ../..
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
            - export SEMAPHORE_SKIP_FLAKY_TETSTS='true'
            - dotnet restore
            - cd test/Confluent.SchemaRegistry.Serdes.IntegrationTests && dotnet test -l "console;verbosity=normal" && cd ../..
            # - cd test/Confluent.SchemaRegistry.IntegrationTests && dotnet test -l "console;verbosity=normal" && cd ../..
<<<<<<< HEAD
=======

 - name: 'Integration tests'
   dependencies: [ ]
   task:
     agent:
       machine:
         type: s1-prod-ubuntu20-04-amd64-2
     jobs:
       - name: 'Build and test'
         commands:
           - cd test/docker && docker-compose up -d && cd ../..
           - dotnet restore
           - cd test/Confluent.Kafka.IntegrationTests && dotnet test -l "console;verbosity=normal" && cd ../..
 - name: 'Schema registry and serdes integration tests'
   dependencies: [ ]
   task:
     agent:
       machine:
         type: s1-prod-ubuntu20-04-amd64-2
     jobs:
       - name: 'Build and test'
         commands:
           - cd test/docker && docker-compose up -d && cd ../..
           - dotnet restore
           - cd test/Confluent.SchemaRegistry.Serdes.IntegrationTests && dotnet test -l "console;verbosity=normal" && cd ../..
           - cd test/Confluent.SchemaRegistry.IntegrationTests && dotnet test -l "console;verbosity=normal" && cd ../..
>>>>>>> dd5ba22 (Check for Flaky Tests)
=======
=======
            - export onSemaphore='set'
>>>>>>> 70283a3 (ignoring flaky tests)
=======
            - export SEMAPHORE_SKIP_FLAKY_TETSTS='true'
>>>>>>> cd388a0 (PR comment Addressal)
            - dotnet restore
            - cd test/Confluent.SchemaRegistry.Serdes.IntegrationTests && dotnet test -l "console;verbosity=normal" && cd ../..
            - cd test/Confluent.SchemaRegistry.IntegrationTests && dotnet test -l "console;verbosity=normal" && cd ../..
>>>>>>> 0d10166 (Initial build try)
=======
>>>>>>> 8e92bdd (FIXME Comment for ProtobufWithReference and removed SchemaRegistry.IntegrationTests for now from semaphore)
