version: v1.0
name: 'confluent-kafka-dotnet build pipeline'
agent:
  machine:
    type: s1-prod-ubuntu20-04-amd64-1
global_job_config:
  prologue:
    commands:
      - checkout
  env_vars:
    - name: CONFIGURATION
      value: Release
    - name: DOTNET_CLI_TELEMETRY_OPTOUT
      value: 'true'

blocks:
  - name: 'Integration tests'
    dependencies: [ ]
    task:
      agent:
        machine:
          type: s1-prod-ubuntu20-04-amd64-2
      jobs:
        - name: 'Build and test'
          commands:
            - cd test/docker && docker-compose up -d && cd ../..
            - export onSemaphore='set'
            - dotnet restore
            - cd test/Confluent.Kafka.IntegrationTests && dotnet test -l "console;verbosity=normal" && cd ../..
  - name: 'Schema registry and serdes integration tests'
    dependencies: [ ]
    task:
      agent:
        machine:
          type: s1-prod-ubuntu20-04-amd64-2
      jobs:
        - name: 'Build and test'
          commands:
            - cd test/docker && docker-compose up -d && cd ../..
            - export onSemaphore='set'
            - dotnet restore
            - cd test/Confluent.SchemaRegistry.Serdes.IntegrationTests && dotnet test -l "console;verbosity=normal" && cd ../..
            - cd test/Confluent.SchemaRegistry.IntegrationTests && dotnet test -l "console;verbosity=normal" && cd ../..
